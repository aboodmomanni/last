function get_next_line(fd):
    static stash
    buffer = allocate(BUFFER_SIZE + 1)
    if (buffer == NULL):
        return NULL

    while (no '\n
' in stash):
        n_read = read(fd, buffer, BUFFER_SIZE)
        if (n_read <= 0):
            break
        buffer[n_read] = '\0'
        new_stash = join(stash, buffer)
        free(stash)
        stash = new_stash

    free(buffer)

    if (stash is NULL or stash == ""):
        free(stash)
        stash = NULL
        return NULL

    if (stash contains '\n'):
        line = substring(stash, 0, index_of('\n') + 1)
        remainder = substring(stash, index_of('\n') + 1, end)
        free(stash)
        stash = remainder
    else:
        line = duplicate(stash)
        free(stash)
        stash = NULL

    return line
